name: CI/CD â€” MEAN Stack

on:
  push:
    branches: [main, master]

jobs:

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mean-backend:latest ./backend
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mean-backend:latest

      - name: Build and push frontend
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mean-frontend:latest ./frontend
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mean-frontend:latest


  deploy:
    name: Deploy with Blue-Green Cutover
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: SSH Deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN:    ${{ secrets.DOCKERHUB_TOKEN }}
          MONGO_URI:          ${{ secrets.MONGO_URI }}
          CORS_ORIGIN:        ${{ secrets.CORS_ORIGIN }}
        with:
          host:     ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key:      ${{ secrets.EC2_SSH_KEY }}
          envs:     DOCKERHUB_USERNAME,DOCKERHUB_TOKEN,MONGO_URI,CORS_ORIGIN
          script: |
            set -e
            cd ~/app

            echo "$DOCKERHUB_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin

            docker pull $DOCKERHUB_USERNAME/mean-backend:latest

            # Detect currently active backend port
            ACTIVE_PORT=$(grep -oP 'server 127.0.0.1:\K[0-9]+' /etc/nginx/conf.d/backend.conf || echo "3000")

            if [ "$ACTIVE_PORT" = "3000" ]; then
              NEW_PORT=3001
            else
              NEW_PORT=3000
            fi

            echo "Active port: $ACTIVE_PORT"
            echo "Starting new container on: $NEW_PORT"

            # Start new backend container
            docker run -d \
              --name backend_$NEW_PORT \
              -p $NEW_PORT:3000 \
              -e MONGO_URI=$MONGO_URI \
              -e CORS_ORIGIN=$CORS_ORIGIN \
              -e NODE_ENV=production \
              --memory="300m" \
              --restart=unless-stopped \
              $DOCKERHUB_USERNAME/mean-backend:latest

            echo "Waiting for health check..."

            for i in {1..15}; do
              if curl -sf http://localhost:$NEW_PORT/health; then
                echo "Health check passed"
                break
              fi
              sleep 2
            done

            # Update Nginx upstream
            sudo tee /etc/nginx/conf.d/backend.conf > /dev/null <<EOF
            upstream backend {
                server 127.0.0.1:$NEW_PORT;
            }

            server {
                listen 80;

                location /api/ {
                    proxy_pass http://backend;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF

            echo "Reloading Nginx..."
            sudo nginx -s reload

            echo "Stopping old container..."
            docker stop backend_$ACTIVE_PORT || true
            docker rm backend_$ACTIVE_PORT || true

            docker image prune -f
            docker container prune -f

            docker logout

            echo "Blue-Green deployment complete."